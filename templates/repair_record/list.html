
{% extends "base.html" %}
{% load i18n %}

{% block title %}{% translate "List of reports" %}{% endblock %}

{% block css %}
{{ block.super }}
  <style>
    /* For devices sm and xs */
    @media (max-width: 576px) {
        .label-on-border {
            margin-top: -0.75rem !important;
        }
    }

    /* For any other devices */
    @media (min-width: 577px) {
        .label-on-border {
            margin-top: -0.25rem !important;
        }
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-end">
    <a href="{% url 'list_csv_repair_record' %}" download class="btn btn-sm btn-secondary" id="csv-button">CSV</a>
  </div>
  <div class="row align-items-center mb-4">
    <div class="col-sm-12 col-md-5">
      <h1 class="">{% translate "List of reports" %}</h1>
    </div>
    <div class="col">
      <div class="row align-items-center justify-content-end">
        <div class="col-sm-12 col-md-auto align-items-center">
          <div class="d-md-inline-block mb-3 mb-md-0">
            <label for="startDateInput" class="ms-2 position-absolute label-on-border">
              <span class="h6 small bg-white text-muted px-1">{% translate "Start Date" %}</span>
            </label>
            <input type="date" class="form-control mt-2 mb-2" id="startDateInput" placeholder={% translate "Start Date" %}>
          </div>
          <div class="d-none d-md-inline-block">─</div>
          <div class="d-md-inline-block">
            <label for="endDateInput" class="ms-2 position-absolute label-on-border">
              <span class="h6 small bg-white text-muted px-1">{% translate "End Date" %}</span>
            </label>
            <input type="date" class="form-control mt-2 mb-2" id="endDateInput" placeholder={% translate "End Date" %}>
          </div>
        </div>
        <div class="col-sm-12 col-md-auto d-grid">
          <button class="btn btn-secondary" id="searchButton">{% translate "Search" %}</button>
        </div>
      </div>
    </div>
  </div>
  <table id="repair-records" class="display table table-striped table-hover table-bordered" style="width:100%">
    <thead>
      <tr>
        <th>{% translate "Start time" %}</th>
        <th>{% translate "End time" %}</th>
        <th>{% translate "Factory" %}</th>
        <th>{% translate "Section" %}</th>
        <th>{% translate "Master" %}</th>
        <th>{% translate "Performers" %}</th>
        <th>{% translate "Equipment Codename" %}</th>
        <th>{% translate "Equipment Name" %}</th>
        <th>{% translate "Repair Type" %}</th>
        <th>{% translate "Total Time" %}</th>
      </tr>
    </thead>
  </table>
{% endblock %}

{% block js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/i18n/defaults-*.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function() {
        var table = $('#repair-records').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'list_repair_record' %}",
                type: "POST",
                data: function (d) {
                    d.csrfmiddlewaretoken = "{{ csrf_token }}";
                    d.start_date = $("#startDateInput").val();
                    d.end_date = $("#endDateInput").val();
                }
            },
            order: [[0, 'desc']],
            columns: [
                { data: "start_time" },
                { data: "end_time" },
                { data: "factory" },
                { data: "section" },
                { data: "master" },
                { data: "performers" },
                { data: "equipment_codename" },
                { data: "equipment_name" },
                { data: "repair_type" },
                { data: "total_time" }
            ],
            rowCallback: function(row, data) {
                $(row).attr('data-bs-toggle', 'tooltip');
                $(row).attr('title', `<strong>Причина поломки:</strong> ${data.reason}<br><strong>Выполненные работы:</strong> ${data.work_done}`);
            },
            drawCallback: function() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl, { html: true });
                });
            }
        });
    
        $("#searchButton").on("click", function() {
            table.ajax.reload();
        });
    
        // Update date constraints
        $("#startDateInput").on("change", function() {
            var startDate = $(this).val();
            $("#endDateInput").attr("min", startDate);
            if (startDate > $("#endDateInput").val()) {
                $("#endDateInput").val(startDate);
            }
        });
    
        $("#endDateInput").on("change", function() {
            var endDate = $(this).val();
            $("#startDateInput").attr("max", endDate);
            if (endDate < $("#startDateInput").val()) {
                $("#startDateInput").val(endDate);
            }
        });
    });

</script>
{% endblock %}
